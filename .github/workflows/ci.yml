name: CI

on: [push]

jobs:
  ut:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16.13.2]

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

      - name: Cache dependencies
        uses: actions/cache@v3
        id: cache-dependencies
        env:
          cache-name: cache-node-modules
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-build-${{ matrix.node-version }}-${{ env.cache-name }}-${{ hashFiles('**/yarn.lock') }}

      - name: Install dependencies
        if: ${{ steps.cache-dependencies.outputs.cache-hit != 'true' }}
        run: |
          yarn install

      - run: |
          yarn test:unit

  package:
    runs-on: ubuntu-latest

    if: |
      startsWith(github.ref, 'refs/heads/release') ||
      github.ref_type == 'tag'

    needs: [ut]

    strategy:
      matrix:
        node-version: [16.13.2]
        os: [win, mac]

    steps:
      - name: Checkout 'LatteArt' Repository
        uses: actions/checkout@v2
        with:
          ref: ${{ github.ref }}
          path: latteart

      - name: Checkout 'LatteArt Capture CL' Repository
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository_owner }}/latteart-capture-cl
          ref: ${{ github.ref }}
          path: latteart-capture-cl

      - name: Checkout 'LatteArt Repository' Repository
        uses: actions/checkout@v2
        with:
          repository: ${{ github.repository_owner }}/latteart-repository
          ref: ${{ github.ref }}
          path: latteart-repository

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v1
        with:
          node-version: ${{ matrix.node-version }}

      - name: Cache dependencies of 'LatteArt'
        uses: actions/cache@v3
        id: cache-latteart-dependencies
        env:
          cache-name: cache-node-modules
        with:
          path: "latteart/**/node_modules"
          key: ${{ runner.os }}-package-${{ matrix.node-version }}-${{ env.cache-name }}-${{ hashFiles('latteart/**/yarn.lock') }}

      - name: Install dependencies of 'LatteArt'
        if: ${{ steps.cache-latteart-dependencies.outputs.cache-hit != 'true' }}
        run: |
          cd latteart
          yarn install
          cd ..

      - name: Package 'LatteArt'
        run: |
          cd latteart
          yarn package:${{ matrix.os }}
          cd ..

      - name: Cache dependencies of 'LatteArt Repository'
        uses: actions/cache@v3
        id: cache-repository-dependencies
        env:
          cache-name: cache-node-modules
        with:
          path: "latteart-repository/**/node_modules"
          key: ${{ runner.os }}-package-${{ matrix.node-version }}-${{ env.cache-name }}-${{ hashFiles('latteart-repository/**/yarn.lock') }}

      - name: Install dependencies of 'LatteArt Repository'
        if: ${{ steps.cache-repository-dependencies.outputs.cache-hit != 'true' }}
        run: |
          cd latteart-repository
          yarn install
          cd ..

      - name: Package 'LatteArt Repository'
        run: |
          cd latteart-repository
          yarn typescript-json-validator src/lib/settings/Settings.ts
          yarn package:${{ matrix.os }}
          cd ..

      - name: Cache dependencies of 'LatteArt Capture CL'
        uses: actions/cache@v3
        id: cache-capture-cl-dependencies
        env:
          cache-name: cache-node-modules
        with:
          path: "latteart-capture-cl/**/node_modules"
          key: ${{ runner.os }}-package-${{ matrix.node-version }}-${{ env.cache-name }}-${{ hashFiles('latteart-capture-cl/**/yarn.lock') }}

      - name: Install dependencies of 'LatteArt Capture CL'
        if: ${{ steps.cache-capture-cl-dependencies.outputs.cache-hit != 'true' }}
        run: |
          cd latteart-capture-cl
          yarn install
          cd ..

      - name: Package 'LatteArt Capture CL'
        run: |
          cd latteart-capture-cl
          yarn package:${{ matrix.os }}
          cd ..

      - name: Make Artifact
        run: |
          mkdir artifact
          cp -r latteart/dist/latteart/* artifact
          cp -r latteart-capture-cl/dist/latteart/* artifact
          cp -r latteart-repository/dist/latteart/* artifact

      - name: Build Artifact Name
        id: build_artifact_name
        run: |
          ARTIFACT_NAME=$(echo ${{ github.ref_name }} | sed "s/\//-/g")
          echo ::set-output name=artifact_name::$ARTIFACT_NAME

      - name: Upload Artifact
        uses: actions/upload-artifact@v2
        with:
          name: latteart-${{ steps.build_artifact_name.outputs.artifact_name }}-${{ matrix.os }}
          path: artifact
